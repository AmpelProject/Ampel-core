
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deploying a new Ampel version &#8212; Ampel 0.7.0a0 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Updating the archive database schema" href="archive_schema.html" />
    <link rel="prev" title="Updating the documentation on GitHub" href="docs.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="archive_schema.html" title="Updating the archive database schema"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="docs.html" title="Updating the documentation on GitHub"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.7.0a0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Operations guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Deploying a new Ampel version</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="deploying-a-new-ampel-version">
<h1>Deploying a new Ampel version<a class="headerlink" href="#deploying-a-new-ampel-version" title="Permalink to this headline">¶</a></h1>
<p>The number of steps involved in deploying a new Ampel version depend on how much has changed from the configuration currently in production. In the following, I assume that you have set up <cite>ssh</cite> tunneling and Kerberos forwarding such that e.g. <cite>ssh transit.ifh.de</cite> dumps you into a shell on <cite>transit.zeuthen.desy.de</cite> without having to issue any more commands or enter a password. The top-level sections below describe the steps in the order they should be peformed, along with the conditions that make each necessary. If these conditions do not apply, you can skip the step and re-use the products of the previous deployment, e.g. the image or live database.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently all the custom components of Ampel run on <cite>burst</cite>, so updates only involve restarting services there. The exception are upgrades to the avro alert schema stored in the archive database, which require operations on <cite>transit</cite> only.</p>
</div>
<div class="section" id="test-test-and-test-again">
<h2>Test, test, and test again<a class="headerlink" href="#test-test-and-test-again" title="Permalink to this headline">¶</a></h2>
<p>Testing on the production system should be avoided unless absolutely necessary. Make sure the unit tests pass, and write unit tests for every new feature you’ve added since the last release. This will save pain and anguish in the long run.</p>
</div>
<div class="section" id="build-and-push-a-new-ampel-image">
<h2>Build and push a new Ampel image<a class="headerlink" href="#build-and-push-a-new-ampel-image" title="Permalink to this headline">¶</a></h2>
<p>Necessary if any of the following apply:</p>
<ul class="simple">
<li><p>You have added a new Ampel contrib project (e.g. ampel-contrib-foo).</p></li>
<li><p>You have added external dependencies to an existing project</p></li>
<li><p>You have added or changed console_scripts entrypoints in an existing project.</p></li>
</ul>
</div>
</div>
<div class="section" id="set-up-github-repos-to-be-pulled-into-the-image">
<h1>Set up GitHub repos to be pulled into the image<a class="headerlink" href="#set-up-github-repos-to-be-pulled-into-the-image" title="Permalink to this headline">¶</a></h1>
<p>Currently all Ampel repositories are private. To pull them in an automated
fashion, you need to set up deploy keys that give read permission without
needing to type in your password. For each repository you wish to include,
change to <cite>deploy/docker-images/devel/deploy-keys</cite> and generate a key pair:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ssh-keygen -t rsa -b 4096 -f ./id_rsa-$NAME
</pre></div>
</div>
<p>where <cite>$NAME</cite> is a short name associated with the repository, e.g. <cite>ampel-contrib-hu</cite>. For reasons that are <a class="reference external" href="https://eclipsesource.com/blogs/2012/07/30/accessing-multiple-private-github-repositories-without-a-dedicated-build-user/">complicated and irritating</a>, the <cite>$NAME</cite> must match the fake domain name used in the <cite>git clone</cite> lines in the <cite>Dockerfile</cite>. Make an unencrypted key, i.e. one with no password. Point your web browser to the deploy keys page of the repository, e.g. <a class="reference external" href="https://github.com/AmpelProject/Ampel-core/settings/keys/new">https://github.com/AmpelProject/Ampel-core/settings/keys/new</a>, and paste the contents of <cite>.id_rsa-$NAME.pub</cite> into the form.</p>
<p>Now, for each new repository you wish to add to the image, add a <cite>git clone</cite> line to the Dockerfile, replacing <cite>github.com</cite> with <cite>$NAME</cite>. Also add a pair of lines to the <cite>pip</cite> section of <cite>environment.yml</cite> to <cite>pip install -e</cite> the new repository at build time.</p>
</div>
<div class="section" id="build-and-tag-the-image">
<h1>Build and tag the image<a class="headerlink" href="#build-and-tag-the-image" title="Permalink to this headline">¶</a></h1>
<p>Change to <cite>deploy/docker-images/devel</cite> and <cite>docker build -t ampel .</cite>. Grab a coffee or 3 while the image builds.</p>
</div>
<div class="section" id="push-image-to-ampel-machines">
<h1>Push image to Ampel machines<a class="headerlink" href="#push-image-to-ampel-machines" title="Permalink to this headline">¶</a></h1>
<p>To transfer the image to <cite>burst</cite> and <cite>transit</cite>, you need to first publish the image to a Docker registry. Since we just got finished jumping through a series of hoops to build with private GitHub repositories, it seems silly to now turn around and push the resulting image to the public Docker Hub. Luckily, though, we can just run a private instance of the Docker registry. Start it like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5000</span><span class="p">:</span><span class="mi">5000</span> <span class="o">--</span><span class="n">restart</span><span class="o">=</span><span class="n">always</span> <span class="o">--</span><span class="n">name</span> <span class="n">registry</span> <span class="n">registry</span><span class="p">:</span><span class="mi">2</span>
</pre></div>
</div>
<p>If you have dome this before, you may get an error message telling you that the name <cite>registry</cite> is already occupied. That’s fine; you just want to ensure that the registry is running. Now, tag the Ampel image and push it to the registry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">tag</span> <span class="n">ampel</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">ampel</span><span class="p">:</span><span class="n">v0</span><span class="o">.</span><span class="mf">3.5</span>
<span class="n">docker</span> <span class="n">push</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">ampel</span><span class="p">:</span><span class="n">v0</span><span class="o">.</span><span class="mf">3.5</span>
</pre></div>
</div>
<p>Now, pull the image from the remote side:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">R5000</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span> <span class="n">transit</span><span class="o">.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span>
<span class="n">sudo</span> <span class="n">su</span> <span class="n">ampel</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ampel</span><span class="o">/</span><span class="n">singularity</span>
<span class="n">SINGULARITY_NOHTTPS</span><span class="o">=</span><span class="mi">1</span> <span class="n">singularity</span> <span class="n">pull</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">ampel</span><span class="p">:</span><span class="n">v0</span><span class="o">.</span><span class="mf">3.5</span>
</pre></div>
</div>
</div>
<div class="section" id="initialize-writable-ampel-source-directories">
<h1>Initialize writable Ampel source directories<a class="headerlink" href="#initialize-writable-ampel-source-directories" title="Permalink to this headline">¶</a></h1>
<p>The read-only Singularity image created in the first step contains clones of the Ampel project repositories. At this stage of development, though, we often need to iterate more quickly than would be practical if we had to build a new image for every single-line change. To that end, the current production configuration mounts a copy of the Ampel repos from the host filesystem over those in the image. To work correctly, however, these have to have the correct names and metadata. The easiest way to ensure this is to copy them directly out of the image <em>as you normal user</em> with e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>singularity-stack volume init /data/ampel/singularity/ampel_v0.3.5.simg /Ampel $AMPEL_SRC
</pre></div>
</div>
<p>where <cite>$AMPEL_SRC</cite>  is the path where you’d like to store the source, e.g. in my case <cite>/scratch/jvs/Ampel_v3</cite>.</p>
<p>You should take care that any changes you make to these sources are tagged and
pushed to GitHub so that a different real user can easily take over as operator.</p>
<div class="section" id="prepare-a-new-live-database">
<h2>Prepare a new live database<a class="headerlink" href="#prepare-a-new-live-database" title="Permalink to this headline">¶</a></h2>
<p>Necessary if:</p>
<ul class="simple">
<li><p>You have changed the structure of the database that the Ampel core expects</p></li>
<li><p>The filters and T2s have changed enough that a fresh start is warranted</p></li>
</ul>
<ol class="arabic simple">
<li><p>On <cite>burst</cite>, become user <cite>ampel</cite> with <cite>sudo su ampel</cite></p></li>
<li><p>Create a directory named after the version of Ampel-core you will run, e.g. <cite>mkdir /data/ampel/mongo/live/v0.3.5</cite></p></li>
<li><p>Adjust <cite>MONGO_PATH</cite> in <cite>$AMPEL_SRC/ampel-core/deploy/production/dryrun.env</cite> to match</p></li>
<li><p>Set a new <cite>GROUP_NAME</cite> following the same convention. This will cause the AlertProcessors to re-ingest all alerts currently in the Kafka stream to the new database rather than starting where the old version left off.</p></li>
</ol>
</div>
<div class="section" id="commit-tag-and-push-local-changes">
<h2>Commit, tag, and push local changes<a class="headerlink" href="#commit-tag-and-push-local-changes" title="Permalink to this headline">¶</a></h2>
<p>In the step above, you might have made changes the host copies of the Ampel repositories. Put these in a reproducible state by commiting the changes, tagging them appropriately, and pushing the tags to GitHub.</p>
</div>
<div class="section" id="obtain-secrets">
<h2>Obtain secrets<a class="headerlink" href="#obtain-secrets" title="Permalink to this headline">¶</a></h2>
<p>Ampel and its plugins manage credentials for local and remote resources, e.g. read or write access to the live database, archive database, or push access to desyCloud. These credentials are not distributed with the source, but kept in read-protected files in a directory called <cite>secrets</cite>, currently in <cite>/home/ampel/dryrun/secrets</cite>. If any new ones have entered the mix, copy them here, making sure that they are owned and readable only by user Ampel.</p>
</div>
<div class="section" id="deploy-ampel">
<h2>Deploy Ampel<a class="headerlink" href="#deploy-ampel" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>On <cite>burst</cite>, change to the directory containing the <cite>secrets</cite> subdirectory, currently <cite>/home/ampel/dryrun</cite>.</p></li>
<li><p>Become user <cite>ampel</cite> with <cite>sudo su ampel</cite></p></li>
<li><p>Redeploy Ampel with <cite>$AMPEL_SRC/ampel-core/deploy/up dryrun</cite>. You should see output like the following:</p></li>
</ol>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(singularity-stack) [burst] /home/ampel/dryrun &gt; /scratch/jvs/Ampel-v0.3/ampel-core/deploy/up dryrun

Stopping 39cf18b4 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=247505)
Stopping 992d0449 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=247322)
Stopping e49305fc instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245195)
Stopping ba08f91e instance of /data/ampel/singularity/mongo-3.6.simg (PID=245010)
Stopping f8b8ce10 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=247150)
Stopping af186630 instance of /data/ampel/singularity/mongo-3.6.simg (PID=244898)
Stopping a9404f1e instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245276)
Stopping a03a6a85 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245365)
Stopping 3dfcfabb instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245454)
Stopping 1a40fc58 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245546)
Stopping 15116b11 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245645)
Stopping 18ee48b0 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245755)
Stopping 90cd2739 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245859)
Stopping 97b8d0c0 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=245972)
Stopping db9e6bc3 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246086)
Stopping 7e5e6d7c instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246203)
Stopping c22ef49f instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246324)
Stopping a87f8253 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246449)
Stopping 3e8914d5 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246575)
Stopping f1652941 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246712)
Stopping eac9a825 instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246851)
Stopping 36535acb instance of /data/ampel/singularity/ampel-v0.3.0.simg (PID=246992)
not clearing anything
connection refused on burst.zeuthen.desy.de:27018, retry after 1 s
connection refused on burst.zeuthen.desy.de:27018, retry after 2 s
connected to burst.zeuthen.desy.de:27018
connection refused on burst.zeuthen.desy.de:27017, retry after 1 s
connection refused on burst.zeuthen.desy.de:27017, retry after 2 s
connected to burst.zeuthen.desy.de:27017
Stack                          Services                       Replicas Instance
============================== ============================== ======= ========
burst                          alertprocessor                 16      a9404f1e
                               catalog                                af186630
                               followup                               f8b8ce10
                               mongo                                  ba08f91e
                               stats                                  e49305fc
                               t2-controller                          992d0449
                               t3-controller                          39cf18b4
------------------------------ ------------------------------ ------- --------
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="check-logs-for-health">
<h2>Check logs for health<a class="headerlink" href="#check-logs-for-health" title="Permalink to this headline">¶</a></h2>
<p>Monitor the logs of each of the services shown in the previous step to make sure the stack came up cleanly, without spewing errors all over the place. For example, to <cite>tail</cite> the logs of the <cite>alertprocessor</cite> service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span><span class="o">-</span><span class="n">stack</span> <span class="n">logs</span> <span class="n">burst</span> <span class="n">alertprocessor</span> <span class="o">-</span><span class="n">f</span>
</pre></div>
</div>
<p>Note that since there are multiple replicas, lines of output may appear to be repeated.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ampel.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="docs.html"
                        title="previous chapter">Updating the documentation on GitHub</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="archive_schema.html"
                        title="next chapter">Updating the archive database schema</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="archive_schema.html" title="Updating the archive database schema"
             >next</a> |</li>
        <li class="right" >
          <a href="docs.html" title="Updating the documentation on GitHub"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.7.0a0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Operations guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Deploying a new Ampel version</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018-2020, Ampel Project contributors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>
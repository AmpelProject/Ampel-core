
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Updating the archive database schema &#8212; Ampel 0.4.0 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Odds and ends" href="misc.html" />
    <link rel="prev" title="Deploying a new Ampel version" href="deploy.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="misc.html" title="Odds and ends"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="deploy.html" title="Deploying a new Ampel version"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Operations guide</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ampel.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="deploy.html"
                        title="previous chapter">Deploying a new Ampel version</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="misc.html"
                        title="next chapter">Odds and ends</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="updating-the-archive-database-schema">
<h1>Updating the archive database schema<a class="headerlink" href="#updating-the-archive-database-schema" title="Permalink to this headline">Â¶</a></h1>
<p>The archive database stores IPAC avro alerts in nearly complete form so that
they can be reprocessed as filters and computations are added and changed in
Ampel. The avro format is however not fixed; IPAC can and does update the
schema at will. In order to catch such changes, the ArchiveDB client checks the
schema version in the avro packet and raises an error if it is newer than the
database schema. To get Ampel running again, the database schema needs to be
updated. This requires 3 steps.</p>
<p>1. Acquire an example of the new schema; either from the UW broker or IPAC
GitHub repo. Write it to a json file in alerts/schema_X.Y.json, where X.Y is
the version number, with <cite>json.dump(schema, f, indent=1)</cite></p>
<ol class="arabic simple" start="2">
<li>Find differences between the old and new schemas, e.g. with <cite>diff -u schema_2.0.json schema_X.Y.json</cite>.</li>
</ol>
<p>3. Using the diff as a guide, write a SQL migration script like the existing
ones in <cite>deploy/production/initdb/archive/*.sql</cite>, prefixing it with a number to
ensure that it is executed in order. For example, the 3.0 schema added fields
to the <cite>candidate</cite> dict that were not present in the 2.0 schema. The migration
script adds these fields to the <cite>candidate</cite> table, and updates the schema version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BEGIN</span><span class="p">;</span>

<span class="o">/*</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">04</span> <span class="n">UT</span><span class="p">:</span> <span class="n">add</span> <span class="n">fields</span> <span class="n">to</span> <span class="n">candidate</span> <span class="o">*/</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">dsnrms</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">ssnrms</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">dsdiff</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">magzpsci</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">magzpsciunc</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">nmatches</span> <span class="n">INTEGER</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">clrcoeff</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">clrcounc</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">zpclrcov</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">zpmed</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">clrmed</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">clrrms</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">neargaia</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">neargaiabright</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">maggaia</span> <span class="n">FLOAT</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">candidate</span> <span class="n">ADD</span> <span class="n">maggaiabright</span> <span class="n">FLOAT</span><span class="p">;</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">versions</span> <span class="p">(</span><span class="n">alert_version</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="mf">3.0</span><span class="p">);</span>

<span class="n">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p>4. Test the migration. The easiest way to do this is to write a test that uses
the <cite>postgres</cite> fixture defined in ampel-core, connects to the resulting
database, and ensures that a) <cite>alert_version</cite> is as expected, and b) the new
fields exist in the table. This works because the fixture mounts the
deploy/production/initdb/archive directory as /docker-initdb.d, causing postgres
to execute all SQL scripts in order after initialization.</p>
<p>5. Commit the migration script. Now, check out the release currently running in
production, cherry-pick the commit you just made to master, create a new
incremental tag, and push it.</p>
<p>6. Moment of truth: apply the migration. ssh to <cite>transit.ifh.de</cite>. Change to the
Ampel-core source directory, pull, and check out the tag you pushed in step 5.
Become user ampel with <cite>sudo su ampel</cite>. Run <cite>singularity-stack</cite> to find the
instance name of the archive container, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">singularity</span><span class="o">-</span><span class="n">stack</span><span class="p">)</span> <span class="p">[</span><span class="n">transit</span><span class="p">]</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ampel</span> <span class="o">&gt;</span> <span class="n">singularity</span><span class="o">-</span><span class="n">stack</span> <span class="nb">list</span>
<span class="n">Stack</span>                          <span class="n">Services</span>                       <span class="n">Replicas</span> <span class="n">Instance</span>
<span class="o">==============================</span> <span class="o">==============================</span> <span class="o">=======</span> <span class="o">========</span>
<span class="n">transit</span>                        <span class="n">archive</span>                                <span class="mf">280e9712</span>
                               <span class="n">graphite</span>                               <span class="mi">061</span><span class="n">fe0d6</span>
<span class="o">------------------------------</span> <span class="o">------------------------------</span> <span class="o">-------</span> <span class="o">--------</span>
</pre></div>
</div>
<p>Now, execute the migration with e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span> <span class="n">exec</span> <span class="n">instance</span><span class="p">:</span><span class="o">//</span><span class="mf">280e9712</span> <span class="n">psql</span> <span class="n">ztfarchive</span> <span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">entrypoint</span><span class="o">-</span><span class="n">initdb</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">MIGRATION</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<p>where <cite>MIGRATION.sql</cite> is the name of the migration script you created in step 3.</p>
<p>7. Verify that alerts are running again by sshing to <cite>burst.ifh.de</cite>, becoming
ampel, observing the lack of scary error messages in the output of
<cite>singularity-stack logs burst alertprocessor -f</cite>.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="misc.html" title="Odds and ends"
             >next</a> |</li>
        <li class="right" >
          <a href="deploy.html" title="Deploying a new Ampel version"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Operations guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Ampel Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>
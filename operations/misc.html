
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Odds and ends &#8212; Ampel 0.7.0a0 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Updating the archive database schema" href="archive_schema.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="archive_schema.html" title="Updating the archive database schema"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.7.0a0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Operations guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Odds and ends</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="odds-and-ends">
<h1>Odds and ends<a class="headerlink" href="#odds-and-ends" title="Permalink to this headline">¶</a></h1>
<div class="section" id="tunnel-directly-to-ampel-subnet">
<span id="ssh-tunnel-config"></span><h2>Tunnel directly to Ampel subnet<a class="headerlink" href="#tunnel-directly-to-ampel-subnet" title="Permalink to this headline">¶</a></h2>
<p>The Ampel subnet is behind two different firewalls, requiring two nested ssh
tunnels to reach. This can be automated by putting the following block in
.ssh/config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host</span> <span class="n">burst</span><span class="o">.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span> <span class="n">transit</span><span class="o">.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span>
  <span class="n">ControlMaster</span> <span class="n">no</span>
  <span class="n">IdentityFile</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="o">.</span><span class="n">zeuthen</span>
  <span class="n">GSSAPIAuthentication</span> <span class="n">no</span>
  <span class="n">GSSAPIDelegateCredentials</span> <span class="n">no</span>
  <span class="n">ProxyCommand</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">q</span> <span class="n">ztf</span><span class="o">-</span><span class="n">wgs</span><span class="o">.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span> <span class="s2">&quot;nc %h %p&quot;</span>

<span class="n">host</span> <span class="n">pub</span><span class="o">*.</span><span class="n">zeuthen</span><span class="o">.</span><span class="n">desy</span><span class="o">.</span><span class="n">de</span>
  <span class="n">ProxyCommand</span> <span class="n">none</span>

<span class="n">host</span> <span class="o">*.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span> <span class="o">*.</span><span class="n">zeuthen</span><span class="o">.</span><span class="n">desy</span><span class="o">.</span><span class="n">de</span>
  <span class="n">User</span> <span class="n">YOURUSERNAME</span>
  <span class="n">ControlMaster</span> <span class="n">auto</span>
  <span class="n">ForwardX11</span> <span class="n">yes</span>
  <span class="n">ForwardX11Trusted</span> <span class="n">yes</span>
  <span class="n">GSSAPIAuthentication</span> <span class="n">yes</span>
  <span class="n">GSSAPIDelegateCredentials</span> <span class="n">yes</span>
  <span class="n">KeepAlive</span> <span class="n">yes</span>
  <span class="n">ServerAliveInterval</span> <span class="mi">55</span>
  <span class="n">ProxyCommand</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">q</span> <span class="n">pub2</span><span class="o">.</span><span class="n">zeuthen</span><span class="o">.</span><span class="n">desy</span><span class="o">.</span><span class="n">de</span> <span class="s2">&quot;nc %h %p&quot;</span>

<span class="n">host</span> <span class="o">*</span>
  <span class="n">AddKeysToAgent</span> <span class="n">Yes</span>
  <span class="n">UseKeychain</span> <span class="n">Yes</span>
</pre></div>
</div>
<p>Replace <cite>~/.ssh/id_rsa.zeuthen</cite> with the path to your public key, and
YOURUSERNAME with your DESY username. Here we’ve used the <cite>ifh.de</cite> alias for
<cite>zeuthen.desy.de</cite> to save typing. Now, you should be able to connect directly
to e.g. <cite>burst</cite> via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">burst</span><span class="o">.</span><span class="n">ifh</span><span class="o">.</span><span class="n">de</span>
</pre></div>
</div>
</div>
<div class="section" id="reset-kafka-consumer-group-offsets">
<h2>Reset Kafka consumer group offsets<a class="headerlink" href="#reset-kafka-consumer-group-offsets" title="Permalink to this headline">¶</a></h2>
<p>The AlertProcessors are fed alerts by a Kafka consumer. These consumers
identify themselves to the broker by a group name (in Ampel, e.g.
ampel-vX.Y.Z-public), and the brokers distributes each message exactly once to
exactly one consumer in the group. This means that once an AlertProcessor has
consumed an alert, you will never see it again. If a situation arises where you
need to replay the alerts from a particular topic, you can reset these using
the command-line tools that ship with Kafka.</p>
<ol class="arabic simple">
<li><p>Shut down all consumers in the group.</p></li>
</ol>
<p>Perform the following steps on transit (only ztf-wgs, transit, and burst are
whitelisted on the UW Kafka server):</p>
<ol class="arabic" start="2">
<li><p>Get a Kafka image: <cite>singularity pull docker://wurstmeister/kafka:2.11-2.0.1</cite></p></li>
<li><p>Check the offsets for the group and topic you want to reset, in this case topic <cite>ztf_20181115_programid2</cite> and group <cite>ampel-v0.4.0-partnership</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span> <span class="n">exec</span> <span class="o">--</span><span class="n">contain</span> <span class="n">kafka</span><span class="o">-</span><span class="mf">2.11</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="mf">1.</span><span class="n">simg</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">kafka</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="n">consumer</span><span class="o">-</span><span class="n">groups</span><span class="o">.</span><span class="n">sh</span> <span class="o">--</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">server</span> <span class="n">epyc</span><span class="o">.</span><span class="n">astro</span><span class="o">.</span><span class="n">washington</span><span class="o">.</span><span class="n">edu</span><span class="p">:</span><span class="mi">9092</span> <span class="o">--</span><span class="n">group</span> <span class="n">ampel</span><span class="o">-</span><span class="n">v0</span><span class="o">.</span><span class="mf">4.0</span><span class="o">-</span><span class="n">partnership</span> <span class="o">--</span><span class="n">describe</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;NR&lt;3 || /ztf_20181115/&#39;</span>

<span class="n">TOPIC</span>                   <span class="n">PARTITION</span>  <span class="n">CURRENT</span><span class="o">-</span><span class="n">OFFSET</span>  <span class="n">LOG</span><span class="o">-</span><span class="n">END</span><span class="o">-</span><span class="n">OFFSET</span>  <span class="n">LAG</span>             <span class="n">CONSUMER</span><span class="o">-</span><span class="n">ID</span>                                  <span class="n">HOST</span>            <span class="n">CLIENT</span><span class="o">-</span><span class="n">ID</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">6</span>          <span class="mi">915</span>             <span class="mi">44166</span>           <span class="mi">43251</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">8</span><span class="n">b6414d5</span><span class="o">-</span><span class="n">e95b</span><span class="o">-</span><span class="mi">47</span><span class="n">ef</span><span class="o">-</span><span class="mi">91</span><span class="n">ed</span><span class="o">-</span><span class="mi">1</span><span class="n">b5c52fb9d56</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">6</span>          <span class="mi">879</span>             <span class="mi">13303</span>           <span class="mi">12424</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">8</span><span class="n">b6414d5</span><span class="o">-</span><span class="n">e95b</span><span class="o">-</span><span class="mi">47</span><span class="n">ef</span><span class="o">-</span><span class="mi">91</span><span class="n">ed</span><span class="o">-</span><span class="mi">1</span><span class="n">b5c52fb9d56</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">8</span>          <span class="mi">782</span>             <span class="mi">44165</span>           <span class="mi">43383</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">bac4e41d</span><span class="o">-</span><span class="mi">8950</span><span class="o">-</span><span class="mi">4175</span><span class="o">-</span><span class="n">af7e</span><span class="o">-</span><span class="mf">22e6711</span><span class="n">a508a</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">8</span>          <span class="mi">764</span>             <span class="mi">13304</span>           <span class="mi">12540</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">bac4e41d</span><span class="o">-</span><span class="mi">8950</span><span class="o">-</span><span class="mi">4175</span><span class="o">-</span><span class="n">af7e</span><span class="o">-</span><span class="mf">22e6711</span><span class="n">a508a</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">3</span>          <span class="mi">803</span>             <span class="mi">44166</span>           <span class="mi">43363</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">6</span><span class="n">a94c6ad</span><span class="o">-</span><span class="n">a874</span><span class="o">-</span><span class="mf">40e7</span><span class="o">-</span><span class="mi">844</span><span class="n">b</span><span class="o">-</span><span class="mi">579</span><span class="n">b09cde9cc</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">3</span>          <span class="mi">776</span>             <span class="mi">13303</span>           <span class="mi">12527</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">6</span><span class="n">a94c6ad</span><span class="o">-</span><span class="n">a874</span><span class="o">-</span><span class="mf">40e7</span><span class="o">-</span><span class="mi">844</span><span class="n">b</span><span class="o">-</span><span class="mi">579</span><span class="n">b09cde9cc</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">5</span>          <span class="mi">708</span>             <span class="mi">13304</span>           <span class="mi">12596</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mf">6e2</span><span class="n">d9175</span><span class="o">-</span><span class="mi">92</span><span class="n">c0</span><span class="o">-</span><span class="mi">4938</span><span class="o">-</span><span class="mi">810</span><span class="n">a</span><span class="o">-</span><span class="mi">72980</span><span class="n">c8a8f27</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">5</span>          <span class="mi">741</span>             <span class="mi">44166</span>           <span class="mi">43425</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mf">6e2</span><span class="n">d9175</span><span class="o">-</span><span class="mi">92</span><span class="n">c0</span><span class="o">-</span><span class="mi">4938</span><span class="o">-</span><span class="mi">810</span><span class="n">a</span><span class="o">-</span><span class="mi">72980</span><span class="n">c8a8f27</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">13</span>         <span class="mi">780</span>             <span class="mi">13304</span>           <span class="mi">12524</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">d3eb71b7</span><span class="o">-</span><span class="mi">34</span><span class="n">a4</span><span class="o">-</span><span class="mi">4710</span><span class="o">-</span><span class="mi">96</span><span class="n">f8</span><span class="o">-</span><span class="mi">0</span><span class="n">f51358be6e3</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">13</span>         <span class="mi">805</span>             <span class="mi">44166</span>           <span class="mi">43361</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">d3eb71b7</span><span class="o">-</span><span class="mi">34</span><span class="n">a4</span><span class="o">-</span><span class="mi">4710</span><span class="o">-</span><span class="mi">96</span><span class="n">f8</span><span class="o">-</span><span class="mi">0</span><span class="n">f51358be6e3</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">15</span>         <span class="mi">828</span>             <span class="mi">44166</span>           <span class="mi">43338</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">f05cf880</span><span class="o">-</span><span class="n">c7f7</span><span class="o">-</span><span class="mi">42</span><span class="n">fc</span><span class="o">-</span><span class="mi">95</span><span class="n">f8</span><span class="o">-</span><span class="mf">9e59149</span><span class="n">cc1d3</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">15</span>         <span class="mi">791</span>             <span class="mi">13303</span>           <span class="mi">12512</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">f05cf880</span><span class="o">-</span><span class="n">c7f7</span><span class="o">-</span><span class="mi">42</span><span class="n">fc</span><span class="o">-</span><span class="mi">95</span><span class="n">f8</span><span class="o">-</span><span class="mf">9e59149</span><span class="n">cc1d3</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">2</span>          <span class="mi">737</span>             <span class="mi">44166</span>           <span class="mi">43429</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">54</span><span class="n">dd569d</span><span class="o">-</span><span class="mi">2</span><span class="n">a2a</span><span class="o">-</span><span class="mi">4726</span><span class="o">-</span><span class="mf">9e21</span><span class="o">-</span><span class="n">fb2ba1a60d51</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">2</span>          <span class="mi">707</span>             <span class="mi">13304</span>           <span class="mi">12597</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">54</span><span class="n">dd569d</span><span class="o">-</span><span class="mi">2</span><span class="n">a2a</span><span class="o">-</span><span class="mi">4726</span><span class="o">-</span><span class="mf">9e21</span><span class="o">-</span><span class="n">fb2ba1a60d51</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">10</span>         <span class="mi">825</span>             <span class="mi">13303</span>           <span class="mi">12478</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">c00dee2a</span><span class="o">-</span><span class="mi">225</span><span class="n">c</span><span class="o">-</span><span class="mi">4875</span><span class="o">-</span><span class="mi">9259</span><span class="o">-</span><span class="mi">5811</span><span class="n">fa28a915</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">10</span>         <span class="mi">863</span>             <span class="mi">44166</span>           <span class="mi">43303</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">c00dee2a</span><span class="o">-</span><span class="mi">225</span><span class="n">c</span><span class="o">-</span><span class="mi">4875</span><span class="o">-</span><span class="mi">9259</span><span class="o">-</span><span class="mi">5811</span><span class="n">fa28a915</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">7</span>          <span class="mi">821</span>             <span class="mi">13303</span>           <span class="mi">12482</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">ba76dd04</span><span class="o">-</span><span class="mi">3592</span><span class="o">-</span><span class="mi">4</span><span class="n">df0</span><span class="o">-</span><span class="mi">97</span><span class="n">bf</span><span class="o">-</span><span class="n">fb3d4c453d62</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">7</span>          <span class="mi">849</span>             <span class="mi">44166</span>           <span class="mi">43317</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">ba76dd04</span><span class="o">-</span><span class="mi">3592</span><span class="o">-</span><span class="mi">4</span><span class="n">df0</span><span class="o">-</span><span class="mi">97</span><span class="n">bf</span><span class="o">-</span><span class="n">fb3d4c453d62</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">12</span>         <span class="mi">832</span>             <span class="mi">44166</span>           <span class="mi">43334</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">d155f375</span><span class="o">-</span><span class="n">a45a</span><span class="o">-</span><span class="mi">49</span><span class="n">bc</span><span class="o">-</span><span class="n">af6b</span><span class="o">-</span><span class="mi">411296018562</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">12</span>         <span class="mi">806</span>             <span class="mi">13303</span>           <span class="mi">12497</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">d155f375</span><span class="o">-</span><span class="n">a45a</span><span class="o">-</span><span class="mi">49</span><span class="n">bc</span><span class="o">-</span><span class="n">af6b</span><span class="o">-</span><span class="mi">411296018562</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">0</span>          <span class="mi">823</span>             <span class="mi">44165</span>           <span class="mi">43342</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">46</span><span class="n">acf77a</span><span class="o">-</span><span class="mi">8</span><span class="n">d9a</span><span class="o">-</span><span class="mi">4</span><span class="n">b21</span><span class="o">-</span><span class="n">b99e</span><span class="o">-</span><span class="n">e07b10fa7d2d</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">0</span>          <span class="mi">796</span>             <span class="mi">13303</span>           <span class="mi">12507</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">46</span><span class="n">acf77a</span><span class="o">-</span><span class="mi">8</span><span class="n">d9a</span><span class="o">-</span><span class="mi">4</span><span class="n">b21</span><span class="o">-</span><span class="n">b99e</span><span class="o">-</span><span class="n">e07b10fa7d2d</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">9</span>          <span class="mi">800</span>             <span class="mi">44166</span>           <span class="mi">43366</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">bb3f4a15</span><span class="o">-</span><span class="n">bb29</span><span class="o">-</span><span class="mi">47</span><span class="n">f0</span><span class="o">-</span><span class="n">b366</span><span class="o">-</span><span class="mi">2612533</span><span class="n">cb979</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">9</span>          <span class="mi">765</span>             <span class="mi">13303</span>           <span class="mi">12538</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">bb3f4a15</span><span class="o">-</span><span class="n">bb29</span><span class="o">-</span><span class="mi">47</span><span class="n">f0</span><span class="o">-</span><span class="n">b366</span><span class="o">-</span><span class="mi">2612533</span><span class="n">cb979</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">11</span>         <span class="mi">873</span>             <span class="mi">44165</span>           <span class="mi">43292</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">c42072ee</span><span class="o">-</span><span class="n">cbb4</span><span class="o">-</span><span class="mi">4283</span><span class="o">-</span><span class="mi">96</span><span class="n">b0</span><span class="o">-</span><span class="n">de0f2cf17de5</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">11</span>         <span class="mi">844</span>             <span class="mi">13304</span>           <span class="mi">12460</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">c42072ee</span><span class="o">-</span><span class="n">cbb4</span><span class="o">-</span><span class="mi">4283</span><span class="o">-</span><span class="mi">96</span><span class="n">b0</span><span class="o">-</span><span class="n">de0f2cf17de5</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">1</span>          <span class="mi">810</span>             <span class="mi">13303</span>           <span class="mi">12493</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">46</span><span class="n">b0e796</span><span class="o">-</span><span class="n">c65f</span><span class="o">-</span><span class="mi">45</span><span class="n">b8</span><span class="o">-</span><span class="mi">9383</span><span class="o">-</span><span class="mi">9</span><span class="n">ae41705fca8</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">1</span>          <span class="mi">841</span>             <span class="mi">44166</span>           <span class="mi">43325</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">46</span><span class="n">b0e796</span><span class="o">-</span><span class="n">c65f</span><span class="o">-</span><span class="mi">45</span><span class="n">b8</span><span class="o">-</span><span class="mi">9383</span><span class="o">-</span><span class="mi">9</span><span class="n">ae41705fca8</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">4</span>          <span class="mi">700</span>             <span class="mi">44166</span>           <span class="mi">43466</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">6</span><span class="n">a96a212</span><span class="o">-</span><span class="n">bd73</span><span class="o">-</span><span class="mi">4741</span><span class="o">-</span><span class="n">b8f2</span><span class="o">-</span><span class="mi">9</span><span class="n">ae356611d81</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">4</span>          <span class="mi">674</span>             <span class="mi">13304</span>           <span class="mi">12630</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="mi">6</span><span class="n">a96a212</span><span class="o">-</span><span class="n">bd73</span><span class="o">-</span><span class="mi">4741</span><span class="o">-</span><span class="n">b8f2</span><span class="o">-</span><span class="mi">9</span><span class="n">ae356611d81</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid2</span> <span class="mi">14</span>         <span class="mi">850</span>             <span class="mi">44166</span>           <span class="mi">43316</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">e2d54690</span><span class="o">-</span><span class="n">ecaa</span><span class="o">-</span><span class="mf">4e38</span><span class="o">-</span><span class="n">a311</span><span class="o">-</span><span class="n">b92fdd699b62</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
<span class="n">ztf_20181115_programid1</span> <span class="mi">14</span>         <span class="mi">822</span>             <span class="mi">13304</span>           <span class="mi">12482</span>           <span class="n">rdkafka</span><span class="o">-</span><span class="n">e2d54690</span><span class="o">-</span><span class="n">ecaa</span><span class="o">-</span><span class="mf">4e38</span><span class="o">-</span><span class="n">a311</span><span class="o">-</span><span class="n">b92fdd699b62</span> <span class="o">/</span><span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">rdkafka</span>
</pre></div>
</div>
</li>
<li><dl>
<dt>Reset the offset to earliest::</dt><dd><p>singularity exec –contain kafka-2.11-2.0.1.simg /opt/kafka/bin/kafka-consumer-groups.sh –bootstrap-server epyc.astro.washington.edu:9092 –group ampel-v0.4.0-partnership –topic ztf_20181115_programid2 –reset-offsets –to-earliest –execute</p>
<p>TOPIC                          PARTITION  NEW-OFFSET
ztf_20181115_programid2        6          0
ztf_20181115_programid2        14         0
ztf_20181115_programid2        2          0
ztf_20181115_programid2        8          0
ztf_20181115_programid2        9          0
ztf_20181115_programid2        11         0
ztf_20181115_programid2        3          0
ztf_20181115_programid2        15         0
ztf_20181115_programid2        10         0
ztf_20181115_programid2        0          0
ztf_20181115_programid2        4          0
ztf_20181115_programid2        12         0
ztf_20181115_programid2        5          0
ztf_20181115_programid2        1          0
ztf_20181115_programid2        13         0
ztf_20181115_programid2        7          0</p>
</dd>
</dl>
</li>
<li><p>Restart the consumers</p></li>
</ol>
<p>There is also a much easier way to do this with <a class="reference external" href="https://github.com/fgeller/kt">kt</a>:</p>
<blockquote>
<div><p>./kt group -brokers partnership.alerts.ztf.uw.edu:9092 -group ampel-v0.5.1-public -topic ztf_20181115_programid2 -reset oldest</p>
</div></blockquote>
<p>You can also combine this with <a class="reference external" href="https://stedolan.github.io/jq/">jq</a> to loop over multiple topics, e.g. to reset
the offsets to the latest message on all topics for a given consumer group:</p>
<blockquote>
<div><p>./kt topic -brokers partnership.alerts.ztf.uw.edu:9092 | ./jq –raw-output ‘select(.name | contains(“ztf”)).name’ | while read topic; do
./kt group -brokers partnership.alerts.ztf.uw.edu:9092 -group ampel-v0.5.1-public -topic $topic -reset newest
done</p>
</div></blockquote>
</div>
<div class="section" id="add-a-new-extcats-catalog">
<h2>Add a new extcats catalog<a class="headerlink" href="#add-a-new-extcats-catalog" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Punch a hole in the firewall for <cite>rsync</cite> from ztf-wgs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">R5000</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">22</span> <span class="n">burst</span>
</pre></div>
</div>
</li>
<li><p>Become user ampel and sync catalogs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="n">ampel</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ampel</span><span class="o">/</span><span class="n">catalogs</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">--</span><span class="n">progress</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;ssh -p 5000&#39;</span> <span class="n">jvsanten</span><span class="nd">@localhost</span><span class="p">:</span><span class="o">/</span><span class="n">lustre</span><span class="o">/</span><span class="n">fs19</span><span class="o">/</span><span class="n">group</span><span class="o">/</span><span class="n">cta</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">mgiomi</span><span class="o">/</span><span class="n">mongodumps</span> <span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>Restore catalogs and update roles:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SINGULARITYENV_MONGO_INITDB_ROOT_PASSWORD=`cat ~/dryrun/secrets/mongo-root-password.txt` SINGULARITYENV_MONGO_INITDB_ROOT_USERNAME=root singularity-stack exec catalogs extcats /docker-entrypoint-initdb.d/add_catalog.sh -p $PREFIX $CATALOG_NAME
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>where <cite>CATALOG_NAME</cite> is the name of the catalog you just rsynced, and
<cite>$PREFIX</cite> is an optional prefix, e.g. the name of the AMPEL channel the
catalog was prepared for. This can be useful if channels provide cut-down
versions of published catalogs.</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>If the catalog container was not started with the initdb dir mounted,</dt><dd><p>execute from a separate container:</p>
</dd>
</dl>
<p>SINGULARITYENV_MONGO_INITDB_ROOT_PASSWORD=`cat ~/dryrun/secrets/mongo-root-password.txt` SINGULARITYENV_MONGO_INITDB_ROOT_USERNAME=root SINGULARITYENV_MONGODUMP_DIR=/mnt  SINGULARITYENV_MONGO_USER=filterclient singularity exec -B ~/Ampel-v0.6.0/ampel-deploy/production/initdb/catalog/:/docker-entrypoint-initdb.d/ -B /data/ampel/catalogs/mongodumps:/mnt /data/ampel/singularity/mongo-4.0.simg /docker-entrypoint-initdb.d/add_catalog.sh -p $PREFIX $CATALOG_NAME</p>
</div>
</div>
<div class="section" id="add-a-new-catshtm-catalog">
<h2>Add a new catsHTM catalog<a class="headerlink" href="#add-a-new-catshtm-catalog" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Punch a hole in the firewall for <cite>rsync</cite> from ztf-wgs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">R5000</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">22</span> <span class="n">burst</span>
</pre></div>
</div>
</li>
<li><p>Become user ampel and sync catalogs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="n">ampel</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ampel</span><span class="o">/</span><span class="n">catalogs</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">--</span><span class="n">progress</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;ssh -p 5000&#39;</span> <span class="n">jvsanten</span><span class="nd">@localhost</span><span class="p">:</span><span class="o">/</span><span class="n">lustre</span><span class="o">/</span><span class="n">fs19</span><span class="o">/</span><span class="n">group</span><span class="o">/</span><span class="n">cta</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">mgiomi</span><span class="o">/</span><span class="n">catsHTM2</span> <span class="o">.</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="export-target-catalog-for-cross-checks">
<h2>Export target catalog for cross-checks<a class="headerlink" href="#export-target-catalog-for-cross-checks" title="Permalink to this headline">¶</a></h2>
<p>On burst: (replace <cite>af186630</cite> with the container id of the catalog service, and <cite>$PASSWORD</cite> with the catalog read password):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>singularity shell instance://af186630
cd /docker-entrypoint-initdb.d/
mongoexport --port 27018 --username filterclient --password $PASSWORD --authenticationDatabase admin --db ToO --collection neutrinos --jsonArray -o neutrinos.json
</pre></div>
</div>
</div>
<div class="section" id="create-channels-access-info-for-the-front-end">
<h2>Create channels access info for the front-end<a class="headerlink" href="#create-channels-access-info-for-the-front-end" title="Permalink to this headline">¶</a></h2>
<p>On burst:</p>
<blockquote>
<div><p>singularity-stack exec burst t3-controller – python -m ampel.contrib.hu.t3.TransientWebPublisher frontend-config &gt; /scratch/frontend_config.tar.gz</p>
</div></blockquote>
<p>From ztf-wgs:</p>
<blockquote>
<div><p>cd ~jvsanten/public/www/ampel/FrontEnd
scp burst:/scratch/frontend_config.tar.gz .
tar xzf frontend_config.tar.gz</p>
</div></blockquote>
<p>Or in one shot:</p>
<blockquote>
<div><p>echo ‘exec bash -ic “singularity-stack exec burst t3-controller – python -m ampel.contrib.hu.t3.TransientWebPublisher frontend-config”’ | ssh burst sudo su ampel &gt; ~/public/www/ampel/FrontEnd/frontend_config.tar.gz</p>
</div></blockquote>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ampel.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="archive_schema.html"
                        title="previous chapter">Updating the archive database schema</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="archive_schema.html" title="Updating the archive database schema"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ampel 0.7.0a0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Operations guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Odds and ends</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Ampel Project.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>
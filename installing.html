
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Installing &#8212; ampel-core 0.7.1-alpha.10 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Running the automated tests" href="testing.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="testing.html" title="Running the automated tests"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ampel-core 0.7.1-alpha.10 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installing</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installing">
<h1>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="environment">
<span id="installing-environment"></span><h2>Environment<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<p>Ampel requires Python &gt;= 3.8. If you already have Python 3.8 on your system, create and activate a <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> for Ampel with:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">python3 -m venv ampel-v0.7</span>
<span class="go">source ampel-v0.7/bin/activate</span>
</pre></div>
</div>
<p>Otherwise, a good way to get Python 3.8 is with <a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">miniconda</a>. After installing <code class="docutils literal notranslate"><span class="pre">miniconda</span></code>, create an environment containing Python 3.8 with:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">conda create -y -n ampel-v0.7 python=3.8</span>
<span class="go">conda activate ampel-v0.7</span>
</pre></div>
</div>
</div>
<div class="section" id="ampel-packages">
<h2>Ampel packages<a class="headerlink" href="#ampel-packages" title="Permalink to this headline">¶</a></h2>
<p>To develop and test a contributed plug-in, you will need to install the Ampel Python packages and their dependencies from within your environment. You can install the packages needed to work with ZTF alerts from PyPI via:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">pip install ampel-ztf</span>
</pre></div>
</div>
</div>
<div class="section" id="extra-packages-for-ztf-alerts">
<h2>Extra packages for ZTF alerts<a class="headerlink" href="#extra-packages-for-ztf-alerts" title="Permalink to this headline">¶</a></h2>
<p>If you are developing a plugin that depends on <code class="docutils literal notranslate"><span class="pre">catsHTM</span></code> catalog matching, e.g. via a subclass of <code class="xref py py-class docutils literal notranslate"><span class="pre">DecentFilter</span></code>, you will also need to:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">pip install \</span>
<span class="go">-e git+https://github.com/AmpelProject/Ampel-contrib-HU.git#egg=ampel-contrib-hu</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have two-factor authentication enabled on your GitHub account, your won’t be able to use your account password to authenticate with command-line <code class="docutils literal notranslate"><span class="pre">git</span></code>. Instead, create a <a class="reference external" href="https://github.com/settings/tokens/new">personal access token</a> with <code class="docutils literal notranslate"><span class="pre">repo</span></code> scope, and use that as your password. If you had previously stored your account password in a credential helper (e.g. if <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">config</span> <span class="pre">--system</span> <span class="pre">--get</span> <span class="pre">credential.helper</span></code> says <code class="docutils literal notranslate"><span class="pre">osxkeychain</span></code>), then you will have to remove the password from that credential helper before <code class="docutils literal notranslate"><span class="pre">git</span></code> will ask you for a new one.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since Ampel packages are <a class="reference external" href="https://packaging.python.org/guides/packaging-namespace-packages/#creating-a-namespace-package">PEP 420 namespace packages</a>, <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> will not work. Use <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">.</span></code> instead.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Commonly-used elements of <code class="docutils literal notranslate"><span class="pre">ampel-contrib-hu</span></code> should eventually be moved up into <code class="docutils literal notranslate"><span class="pre">ampel-ztf</span></code>.</p>
</div>
</div>
<div class="section" id="installing-your-own-plug-in">
<h2>Installing your own plug-in<a class="headerlink" href="#installing-your-own-plug-in" title="Permalink to this headline">¶</a></h2>
<p>Once you have the environment set up with Ampel core pacakges, you can install your own plugin (see <a class="reference internal" href="contribute.html#contributing"><span class="std std-ref">Contribute</span></a>) in the environment with:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">git clone https://github.com/SomeOrganization/Ampel-contrib-PROJECTNAME.git</span>
<span class="go">cd ampel-contrib-PROJECTNAME</span>
<span class="go">pip install -e .</span>
</pre></div>
</div>
<p>After this, you should be able to run <code class="code docutils literal notranslate"><span class="pre">ampel-config</span> <span class="pre">build</span></code> and see a gigantic blob of YAML being generated.</p>
</div>
<div class="section" id="development-installation">
<h2>Development installation<a class="headerlink" href="#development-installation" title="Permalink to this headline">¶</a></h2>
<p>tl;dr: <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">install</span></code> installs a single package in editable mode. <code class="docutils literal notranslate"><span class="pre">poetry_dev</span> <span class="pre">path;</span> <span class="pre">poetry</span> <span class="pre">install</span></code> in the <em>most-derived</em> repository installs it and all its (Ampel) dependencies in editable mode.</p>
<p>Core Ampel packages (ampel-interface, ampel-core, ampel-photometry, ampel-alerts, ampel-ztf) use <a class="reference external" href="https://python-poetry.org">poetry</a> for installation and dependency management. To install core package in development mode, change to the directory of the cloned repository and <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">install</span></code>. This will do the following three things:</p>
<ol class="arabic simple">
<li><p>Create a virtual environment for the current project. If you are already in a virtual environment, e.g. one created by <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">create</span></code> or <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">venv</span></code>, <code class="docutils literal notranslate"><span class="pre">poetry</span></code> will use it instead of creating a dedicated one. <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">env</span> <span class="pre">info</span></code> will tell you which environment is being used for a particular project.</p></li>
<li><p>Install the dependencies listed in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> into the virtual environment. If the <code class="docutils literal notranslate"><span class="pre">poetry.lock</span></code> file is missing or out of sync with <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, the dependencies will first be “locked” (fixed to a specific set of versions that satisfies the requirements) and written to <code class="docutils literal notranslate"><span class="pre">poetry.lock</span></code>. Otherwise, <code class="docutils literal notranslate"><span class="pre">poetry</span></code> install the dependencies as given in <code class="docutils literal notranslate"><span class="pre">poetry.lock</span></code>.</p></li>
<li><p>Install the project itself in editable mode by placing a <code class="docutils literal notranslate"><span class="pre">.pth</span></code> file in the <code class="docutils literal notranslate"><span class="pre">site-packages</span></code> directory of the virtual environment.</p></li>
</ol>
<p>This ensures that all developers work with a consistent set of dependencies, and makes it trivial to publish new versions to PyPI.</p>
<p><code class="docutils literal notranslate"><span class="pre">poetry</span></code> works best for <em>isolated</em> development, where each package is developed against a fixed set of upstream dependencies. This can become cumbersome when you want to make changes across multiple Ampel core packages at once, e.g. adding an abstract base class to ampel-interface that you want to use in ampel-alerts. For this kind of development you likely want to have <em>all</em> Ampel core packages installed in editable mode at once. You can do this by replacing the <a class="reference external" href="https://python-poetry.org/docs/dependency-specification/#version-constraints">version dependencies</a> (which fetch and install packages from PyPI) in the dependent package with <a class="reference external" href="https://python-poetry.org/docs/dependency-specification/#path-dependencies">path dependencies</a>, pointing to a local clone of each package’s repository. This process can be automated with <a class="reference external" href="https://pypi.org/project/poetry-dev/">poetry-dev</a>, as illustrated below.</p>
<p>First, we create a virtualenv with <code class="docutils literal notranslate"><span class="pre">conda</span></code> and install <code class="docutils literal notranslate"><span class="pre">poetry_dev</span></code> in it. This will also install <code class="docutils literal notranslate"><span class="pre">poetry</span></code> itself:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">conda env create -n ampel-installtest python=3.8; conda activate ampel-installtest</span>
<span class="go">pip install poetry_dev</span>
</pre></div>
</div>
<p>Next, clone the repositories for <em>all</em> the core Ampel packages:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">git clone git@github.com:AmpelProject/Ampel-interface.git ampel-interface</span>
<span class="go">git clone git@github.com:AmpelProject/Ampel-core.git ampel-core</span>
<span class="go">git clone git@github.com:AmpelProject/Ampel-photometry.git ampel-photometry</span>
<span class="go">git clone git@github.com:AmpelProject/Ampel-alerts.git ampel-alerts</span>
<span class="go">git clone git@github.com:AmpelProject/Ampel-ZTF.git ampel-ztf</span>
</pre></div>
</div>
<p>Then, run <code class="docutils literal notranslate"><span class="pre">poetry_dev</span></code> in <code class="docutils literal notranslate"><span class="pre">ampel-ztf</span></code>, which depends on the other four. This will look for any dependencies whose names match sibling directories (which we ensured by cloning each repository as the package name), and remove them from the requirements. This will cause <code class="docutils literal notranslate"><span class="pre">poetry</span></code> to uninstall any distributions from PyPI that might have already been installed. Then, it will re-add these as path dependencies, causing them to be installed in develop mode:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> ampel-ztf<span class="p">;</span> poetry_dev path
<span class="go">ampel-interface: Changing version requirement @0.7.1-alpha.7 to path requirement../ampel-interface</span>
<span class="go">ampel-core: Changing version requirement @0.7.1-alpha.5 to path requirement../ampel-core</span>
<span class="go">ampel-photometry: Changing version requirement ~0.7.1-alpha.0 to path requirement../ampel-photometry</span>
<span class="go">ampel-alerts: Changing version requirement ~0.7.1-alpha.0 to path requirement../ampel-alerts</span>
<span class="go">Updating dependencies</span>
<span class="go">Resolving dependencies... (6.8s)</span>

<span class="go">Writing lock file</span>

<span class="go">Package operations: 36 installs, 0 updates, 0 removals</span>

<span class="go">  • Installing mypy-extensions (0.4.3)</span>
<span class="go">  • Installing pyparsing (2.4.7)</span>
<span class="go">  • Installing typed-ast (1.4.2)</span>
<span class="go">  • Installing typing-extensions (3.7.4.3)</span>
<span class="go">  • Installing attrs (20.3.0)</span>
<span class="go">  • Installing iniconfig (1.1.1)</span>
<span class="go">  • Installing multidict (5.1.0)</span>
<span class="go">  • Installing mypy (0.800)</span>
<span class="go">  • Installing numpy (1.20.1)</span>
<span class="go">  • Installing packaging (20.9)</span>
<span class="go">  • Installing pluggy (0.13.1)</span>
<span class="go">  • Installing py (1.10.0)</span>
<span class="go">  • Installing six (1.15.0)</span>
<span class="go">  • Installing toml (0.10.2)</span>
<span class="go">  • Installing async-timeout (3.0.1)</span>
<span class="go">  • Installing coverage (5.5)</span>
<span class="go">  • Installing cycler (0.10.0)</span>
<span class="go">  • Installing kiwisolver (1.3.1)</span>
<span class="go">  • Installing pillow (8.1.2)</span>
<span class="go">  • Installing pyerfa (1.7.2)</span>
<span class="go">  • Installing pytest (6.2.2)</span>
<span class="go">  • Installing python-dateutil (2.8.1)</span>
<span class="go">  • Installing sentinels (1.0.0)</span>
<span class="go">  • Installing yarl (1.6.3)</span>
<span class="go">  • Installing aiohttp (3.7.4.post0)</span>
<span class="go">  • Installing astropy (4.2)</span>
<span class="go">  • Installing backoff (1.10.0)</span>
<span class="go">  • Installing confluent-kafka (1.6.0)</span>
<span class="go">  • Installing fastavro (1.3.4)</span>
<span class="go">  • Installing matplotlib (3.3.4)</span>
<span class="go">  • Installing mongomock (3.22.1)</span>
<span class="go">  • Installing nest-asyncio (1.5.1)</span>
<span class="go">  • Installing pytest-asyncio (0.14.0)</span>
<span class="go">  • Installing pytest-cov (2.11.1)</span>
<span class="go">  • Installing pytest-mock (3.5.1)</span>
<span class="go">  • Installing pytest-timeout (1.4.2)</span>
<span class="go">Updating dependencies</span>
<span class="go">Resolving dependencies... (3.1s)</span>

<span class="go">Writing lock file</span>

<span class="go">Package operations: 16 installs, 0 updates, 0 removals</span>

<span class="go">  • Installing argcomplete (1.12.2)</span>
<span class="go">  • Installing pycryptodome (3.10.1)</span>
<span class="go">  • Installing pydantic (1.4)</span>
<span class="go">  • Installing pymongo (3.11.3)</span>
<span class="go">  • Installing pyyaml (5.4.1)</span>
<span class="go">  • Installing xmltodict (0.12.0)</span>
<span class="go">  • Installing prometheus-client (0.9.0)</span>
<span class="go">  • Installing psutil (5.8.0)</span>
<span class="go">  • Installing schedule (1.0.0)</span>
<span class="go">  • Installing sjcl (0.2.1)</span>
<span class="go">  • Installing slackclient (2.9.3)</span>
<span class="go">  • Installing yq (2.12.0)</span>
<span class="go">  • Installing ampel-interface (0.7.1-alpha.8 /afs/ifh.de/group/amanda/scratch/jvsanten/projects/ztf/ampel-installtest2/ampel-interface)</span>
<span class="go">  • Installing ampel-core (0.7.1-alpha.6 /afs/ifh.de/group/amanda/scratch/jvsanten/projects/ztf/ampel-installtest2/ampel-core)</span>
<span class="go">  • Installing ampel-photometry (0.7.1-alpha.1 /afs/ifh.de/group/amanda/scratch/jvsanten/projects/ztf/ampel-installtest2/ampel-photometry)</span>
<span class="go">  • Installing ampel-alerts (0.7.1-alpha.1 /afs/ifh.de/group/amanda/scratch/jvsanten/projects/ztf/ampel-installtest2/ampel-alerts)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that you have <em>all</em> the Ampel core packages cloned in sibling directories before this step. If you were missing e.g. ampel-photometry, it would be installed from PyPI, which would also install its dependencies like ampel-core from PyPI.</p>
</div>
<p>Finally, install <code class="docutils literal notranslate"><span class="pre">ampel-ztf</span></code> itself in develop mode. Since all the dependencies were installed in the previous step, this does nothing but add the <code class="docutils literal notranslate"><span class="pre">.pth</span></code> file:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>poetry install
<span class="go">Installing dependencies from lock file</span>

<span class="go">No dependencies to install or update</span>

<span class="go">Installing the current project: ampel-ztf (0.7.1-alpha.9)</span>
</pre></div>
</div>
<p>You can verify that all packages were installed in editable mode like this:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; ls $(python -c &#39;import site; print(site.getsitepackages()[0])&#39;)/ampel_*.pth</span>
<span class="go">/afs/ifh.de/group/amanda/scratch/jvsanten/software/miniconda3/envs/ampel-installtest/lib/python3.8/site-packages/ampel_alerts.pth</span>
<span class="go">/afs/ifh.de/group/amanda/scratch/jvsanten/software/miniconda3/envs/ampel-installtest/lib/python3.8/site-packages/ampel_core.pth</span>
<span class="go">/afs/ifh.de/group/amanda/scratch/jvsanten/software/miniconda3/envs/ampel-installtest/lib/python3.8/site-packages/ampel_interface.pth</span>
<span class="go">/afs/ifh.de/group/amanda/scratch/jvsanten/software/miniconda3/envs/ampel-installtest/lib/python3.8/site-packages/ampel_photometry.pth</span>
<span class="go">/afs/ifh.de/group/amanda/scratch/jvsanten/software/miniconda3/envs/ampel-installtest/lib/python3.8/site-packages/ampel_ztf.pth</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before committing any changes to <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, run <code class="docutils literal notranslate"><span class="pre">poetry_dev</span> <span class="pre">version</span></code> to restore the PyPI dependencies.</p>
</div>
</div>
<div class="section" id="running-a-full-ampel-instance">
<h2>Running a full Ampel instance<a class="headerlink" href="#running-a-full-ampel-instance" title="Permalink to this headline">¶</a></h2>
<p>To run the full Ampel processing chain implemented in the ampel-core project, you will need an instance of MongoDB (&gt;= 4.0). To start one via <code class="docutils literal notranslate"><span class="pre">docker</span></code>:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; docker run -d --rm -p 27017:27017 --name mongo mongo:bionic</span>
<span class="go">9f8724e53d8d4fc44ecf06e5ab5a2f76a1ad773a910ab20c2206cd3669e67496</span>
</pre></div>
</div>
<p>This causes <code class="docutils literal notranslate"><span class="pre">docker</span></code> to start <code class="docutils literal notranslate"><span class="pre">mongod</span></code> in a background container named <code class="docutils literal notranslate"><span class="pre">mongo</span></code>, with port 27017 bound to port 27017 on the host. The value printed to the console is the id of the container; you can refer to it either using this hash or the name you provided (<code class="docutils literal notranslate"><span class="pre">mongo</span></code>). You may verify that ports are forwarded to the host correctly with with <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">inspect</span></code>:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; docker inspect mongo | jq &#39;.[] | .NetworkSettings.Ports&#39;</span>
<span class="go">{</span>
<span class="go">  &quot;27017/tcp&quot;: [</span>
<span class="go">    {</span>
<span class="go">      &quot;HostIp&quot;: &quot;0.0.0.0&quot;,</span>
<span class="go">      &quot;HostPort&quot;: &quot;27017&quot;</span>
<span class="go">    }</span>
<span class="go">  ]</span>
<span class="go">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">mongod</span></code> started this way has no access control whatsoever, and should only be used for local development. Always use authenticated, minimially-priviledged users in production.</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/ampel.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="testing.html"
                        title="previous chapter">Running the automated tests</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="testing.html" title="Running the automated tests"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ampel-core 0.7.1-alpha.10 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installing</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018-2021, Ampel Project.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.3.
    </div>
  </body>
</html>
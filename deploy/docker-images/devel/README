
# Building a Singularity dev image with Docker

This is a multi-step process. You have to:
0. Obtain or create the Ampel GitHub deploy key
1. Build the image
2. Tag the image and push it to a local registry (essentially a local instance of DockerHub)
3. Forward a port from the target machine back to the local registry
4. Import the Docker image and convert it to Singularity format from the target system

# Create deploy key
ssh-keygen -t rsa -b 4096 -f ./id_rsa
# paste contents of id_rsa.pub into https://github.com/AmpelProject/Ampel/settings/keys/new
# (If you make your own, be sure to give it a descriptive name so that it can be revoked if
# needed)

# Build the image
docker build -t ampel .

# Push to a local Docker registry
docker run -d -p 5000:5000 --restart=always --name registry registry:2
docker tag ampel localhost:5000/ampel:v0.1a5
docker push localhost:5000/ampel:v0.1a5

# Forward port to target system with Singularity
ssh -R5000:localhost:5000 transit.ifh.de

# Import image
sudo su ampel
cd $SINGULARITY_CACHEDIR
SINGULARITY_NOHTTPS=1 singularity pull docker://localhost:5000/ampel:v0.1a5
# now, adjust image version tag in docker-compose.yml to whatever you just pulled (in this example, v0.1a5)

# Unrelated side topic: populating catalog database from mongodump bson files
# from mongodump directory:
singularity shell instance://atest.catalog
mongorestore --port 2002 --username root -p mongo .
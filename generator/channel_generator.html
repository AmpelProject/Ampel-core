<!DOCTYPE html>
<html>
<head>

<link rel='stylesheet' type='text/css' href='prism.css' />
<link rel='stylesheet' type='text/css' href='jquery-ui.min.css'/>
<link rel='stylesheet' type='text/css' href='tooltipster.bundle.min.css' />
<link rel='stylesheet' type='text/css' href='tooltipster-sideTip-shadow.min.css' />


<script type="text/javascript" src="jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="jquery-ui.min.js"></script>
<script type="text/javascript" src="tooltipster.bundle.min.js"></script>
<script type="text/javascript" src="tooltipster-follower.min.js"></script>
<script type="text/javascript" src="prism.js"></script>

<script type='text/javascript'>

	ztf_alert_fields = [
		'aimage', 'aimagerat', 'bimage', 'bimagerat', 'candid', 'chinr', 
		'chipsf', 'classtar', 'dec', 'decnr', 'diffmaglim', 'distnr', 'distpsnr1', 
		'elong', 'fid', 'field', 'fwhm', 'isdiffpos', 'jd', 'jdendhist', 'jdstarthist', 
		'magap', 'magapbig', 'magdiff', 'magfromlim', 'magnr', 'magpsf', 'mindtoedge', 
		'nbad', 'ncovhist', 'ndethist', 'nid', 'nneg', 'pdiffimfilename', 'pid', 
		'programid', 'programpi', 'ra', 'ranr', 'rb', 'rcid', 'scorr', 'seeratio', 
		'sgmag', 'sgscore', 'sharpnr', 'sigmagap', 'sigmagapbig', 'sigmagnr', 'sigmapsf', 
		'simag', 'sky', 'srmag', 'ssdistnr', 'ssmagnr', 'ssnamenr', 'sumrat', 'szmag', 
		'tblid', 'xpos', 'ypos'
	];

	alert_operators = [
		'>', '<', '>=', '<=', '==', '!='
	];

	pps_operators = [
		'>', '<', '>=', '<=', '==', '!=', 'is', 'is not'
	];

	t2_run_config_fields = [
		't2Unit', 'runConfig', 'author', 'version',	'lastChange', 'private', 'parameters'
	];

  	tbl_model = "";
  	t2_units = "";

	$(document).ready(

		function() {

			// Init tooltips
		  	init_tooltipster();
		
			// Add click events to buttons
		    $("#slackpublisher").click(
				function(){
					var sptbl = $("#tableslackpublisher");
					var visible = $("#tableslackpublisher").is(":visible");
					sptbl.fadeToggle("slow");
					if (!visible)
						$("#spchannel").focus();
				}
			);

		    $("#doit").click(gen_confs);

			// Add on key event
			$(".keypress_new_alert_crit").eq(0).on(
				"keydown", 
				function (e) {
    				if (e.keyCode === 13) {  // pressed key is "Enter"
        				add_alert_crit(
							$(".keypress_new_alert_crit").eq(0)[0]
						);
    				}
				}
			);

			// Populate fields dropdown
			$(".s_fields").each(
				function() {
					populate_dd(
						$(this), ztf_alert_fields
					);
				}
			);

			// Populate alert operators dropdown
			$(".s_alert_operators").each(
				function() {
					populate_dd(
						$(this), alert_operators
					);
				}
			);

			// Populate pps operators dropdown
			$(".s_pps_operators").each(
				function() {
					populate_dd(
						$(this), pps_operators
					);
				}
			);

			// Cosmetic
			$(".outer_logical_connector:first").css(
				{
    				'width': $("#t0outer").outerWidth() + 'px'
  				}
			);

			// Init accordion (it must be placed before the previous cosmetic line)
			$("#accordion").accordion();

			// Copy generated outer div html content
			tbl_model = $(".t0outerdiv").eq(0).clone();

			// Retrieve AMPEL JSON config files
			$.getJSON("t2_units.json").done(

				function(json) {

					// Save result
					t2_units = json;

					// Retrieve run config json file
					$.getJSON("t2_run_config.json").done(

						function(json2) {

							// Save result
							t2_run_config = json2;

							// Create T2 checkboxes and associated content
							for (y=0; y < t2_units.length; y++) {
								create_t2(t2_units[y], t2_run_config);
							}

							// Cosmetic
							$("#T2").append($("<br><br>"))

							// Init tooltips (we do it now because the generated
							// t2 html elements use tooltips as well)
							init_tooltipster();
						}

					).fail(
						function() {
							alert("Unable to retrieve t2_run_config.json");
						}
					);
				}

			).fail(
				function() {
					alert("Unable to retrieve t2_units.json");
				}
			);
		}
	);


	function gen_confs() {

		channel_config = {

			"_id" : $("#channel_name").val().toUpperCase(),
			"version": 1.0,
			"active" : false,

    		"input" : [ 
        		{
            		"instrument" : "ZTF",
            		"alerts" : "IPAC",
            		"parameters" : {
            		    "ZTFPartner" : true,
						"autoComplete" : $("#autocomplete").prop('checked'),
						"updatedHUZP" : false
					}
				}
			],

    		"t0Filter" : {
			},

    		"t2Compute" : [],

			"t3Supervise" : []
		};

		t0_config = {};
		t2_run_configs = [];
		t3_runconfig = {};

		var ret = true;

		/********************
		    CHANNEL DETAILS 
		*********************/

		$(".channel_details_input").each(
			function() {
				ret = check_missing_value($(this), 0);
				return ret;
			}
		);

		// break in case last each() detected an error
		if (ret == false)
			return false;

		/***************
		    T0 CONF
		***************/

		// Robustness: check for empty text fields
		$(".rule_pps_len, .filter_crit_val").each(
			function() {
				ret = check_missing_value($(this), 1);
				return ret;
			}
		);

		// break in case last each() detected an error
		if (ret == false)
			return false;

		// Robustness: check for non-numerical text fields
		$(".rule_pps_len").each(
			function() {
				ret = check_is_numerical($(this), 1);
				return ret;
			}
		);

		// break in case last each() detected an error
		if (ret == false)
			return false;

		// Single filter
		if ($(".t0outerdiv").length == 1) {

			var crits = [];

			$(".s_fields").each(
				function() {
					crits.push(
						build_crit_dict($(this))
					);
				}
			);

			channel_config["t0Filter"] = {
        		"id" : "BasicFilter",
				"runConfig" : {
					"criteria" : crits,
					"len" : Number(
						$(".rule_pps_len").eq(0).val()
					),
					"operator": $(".s_alert_operators").eq(0).val()
				}
			}
		}
		// Multi filter
		else {
		
			var filters = [];

			$(".t0outerdiv").each(

				function() {

					var filter = {"criteria": []};
					var ilc = $(this).find(".inner_logical_connector");

					if (ilc.length == 1) {
						filter["logicalConnection"] = ilc.data("logical-connection");
					}

					$(this).find(".s_fields").each(
						function() {
							filter["criteria"].push(
								build_crit_dict($(this))
							);
						}
					);

					filter["len"] = Number(
						$(this)
							.find(".rule_pps_len")
							.eq(0)
							.val()
					);

					filter["operator"] = 
						$(this)
							.find(".s_alert_operators")
							.eq(0)
							.val();

					filters.push(filter)
				}
			);

			channel_config["t0Filter"] = {
        		"id" : "BasicMultiFilter",
				"runConfig" : {
					"filters" : filters
				}
			}
		
		}


		/***************
		    T2 CONF
		***************/

		// get T2 modules selected by user
		$(".t2_checkbox:checked").each(

			function() {

				var t2div = $(this).closest(".t2div");

				/********************************
					PART 1: ROBUSTNESS CHECKS
				*********************************/

				// Get selected run config
				var checked_t2_radio = $(this).closest(".t2div").find("input[type=radio]:checked");

				// Check for none run config selection
				if (checked_t2_radio.length == 0) {
					alert(
						"Please select a run configuration for t2 unit: " + 
						$(this).closest("input[type=checkbox]").prop("id")
					);
					return false;
				}

				var run_config_name = "";

				// Custom run config parameters were provided
				if (checked_t2_radio.prop("class") == 't2_custom') {

					// Get runconfig id string
					run_config_name = checked_t2_radio
						.closest("table")
						.find("[data-runconf-custom-el=runConfig]")
						.val();
	
					// Check empty text fields
					$(this).closest(".t2div").find("input[type=text]").each(
						function() {
							if ($(this).val() == "") {
								alert("Text field '"+$(this).data("runconf-custom-el")+"' must be filled");
								$(this).focus();
								ret = false;
								return false;
							}
						}
					);
	
					// break in case last each() detected an error
					if (ret == false)
						return false;
	
					// Check empty JSON in text area
					$(this).closest(".t2div").find("textarea").each(
	
						function() {
	
							json = null;

							try {
								json = JSON.parse(
									$(this).val()
								);
							} 
							catch (e) {
								alert("Provided JSON could not be loaded:\n"+e);
							}
	
							if (Object.keys(json).length == 0) {
								alert("Field 'parameters' contains an empty JSON structure");
								$(this).focus();
								ret = false;
								return false;
							}
						}	
					);
	
					// break in case last each() detected an error
					if (ret == false)
						return false;

					// Loop through other 'runconfig' radio buttons
					// to check for possible name conflict
					t2div.find("input[type=radio]").each(
						function() {
							if (run_config_name == $(this).data("runconf-label")) {
								alert("Run config name '"+run_config_name+"' is already in use");
								checked_t2_radio.closest("table").find("[data-runconf-custom-el=runConfig]").focus();
								ret = false;
								return false;
							}
						}
					);
				
					// break in case last each() detected an error
					if (ret == false)
						return false;

					/****************************************
						PART 2a: GENERATE RUNCONFIG JSON
					****************************************/
					
					// for cosmetic reasons (key order)
					tmp_dict = {}; 
									
					for (var z=0; z<t2_run_config_fields.length; z++) {

						var val = t2div.find(
							"[data-runconf-custom-el="+t2_run_config_fields[z]+"]"
						).val();

						if (val === undefined) {
							alert(
								"Input text matching find criteria '[data-runconf-custom-el=" + 
								t2_run_config_fields[z] + "]' not found"
							);
							return false;
						}

						// Get rid of \n & co 
						if (t2_run_config_fields[z] == "parameters") {
							tmp_dict[t2_run_config_fields[z]] = JSON.parse(val);
						}
						else {
							tmp_dict[t2_run_config_fields[z]] = val;
						}
					};

					t2_run_config = {
						'_id': tmp_dict['t2Unit'] + '_' + tmp_dict['runConfig']
					};
					t2_run_configs.push(t2_run_config);

					// for cosmetic reasons (key order)
					for (var z=0; z<t2_run_config_fields.length; z++) {
						t2_run_config[t2_run_config_fields[z]] = tmp_dict[t2_run_config_fields[z]];
					}

				}
				else {
					run_config_name = t2div
						.find("input[type=radio]:checked")
						.data("runconf-label");
				}


				/**************************************
					PART 2b: update channel t2 config
				**************************************/

				channel_config["t2Compute"].push(
					{
						"t2Unit": $(this)
							.closest(".t2div")
							.data("t2-unit-name"), 
						"runConfig": run_config_name
					}
				);
			}
		);

		// break in case last each() detected an error
		if (ret == false)
			return false;


		/**************************************
			PART 2b: GENERATE CHANNEL JSON
		**************************************/

		if ($("#gjson").length == 0) {

			var gjson_div = $("<div/>");
			gjson_div.attr({'id': 'gjson'});

			gjson_div.append(
				create_gjson_div("Channel config:", "chan_config")
			);

			gjson_div.append(
				create_gjson_div("T2 run config:", "t2_run_config")
			);

			gjson_div.append(
				create_gjson_div("T3 run config:", "t3_run_config")
			);

			$("#accordion")
				.append($("<h3>Generated JSON</h3>"))
				.append(gjson_div)
				.accordion("refresh")
				.accordion("option", "active", 4);
		}
		else {
			$("#accordion").accordion("option", "active", 4);
		}

		$("#gjson_pre_chan_config").html(
			JSON.stringify(channel_config, null, '\t')
		);

		if (Object.keys(t2_run_configs).length == 0) {
			$("#gjson_div_t2_run_config").hide();
		}
		else {
			$("#gjson_div_t2_run_config").show();
			$("#gjson_pre_t2_run_config").html(
				JSON.stringify(t2_run_configs, null, '\t')
			);
		}

		if (Object.keys(t3_runconfig).length == 0) {
			$("#gjson_div_t3_run_config").hide();
		}
		else {
			$("#gjson_pre_t3_run_config").show();
			$("#gjson_pre_t3_run_config").html(
				JSON.stringify(t3_runconfig, null, '\t')
			);
		}

		// JSON syntax highlighting
		Prism.highlightAll();
	}


	function create_gjson_div(title, id_suffix) {

		var div = $("<div/>");
		div.attr({'id': 'gjson_div_' + id_suffix});
		div.append(document.createTextNode(title));
		var span = $("<span>copy JSON</span>");
		span.attr({'class': 'button'});
		span.css(
			{
				'padding': '5px 8px 5px 8px',
				'margin-left': '10px',
				'background-color': 'rgba(0, 140, 186, 0.59)'
			}
		);
		div.append(span);

		span.on(
			"click", 
				function() {
        			var temp = $("<textarea/>");
          			$("body").append(temp);
          			temp.val(
						$('#gjson_pre_' + id_suffix).text()
					).select();
          			document.execCommand("copy");
          			temp.remove();
    			}
		);

		div.append($("<br/>"));

		var pre_channel = $("<pre/>");
		pre_channel.attr({'class': 'gjson_pre'});
		div.append(pre_channel);

		var code = $("<code/>");
		pre_channel.append(code);
		code.attr(
			{
				'id': 'gjson_pre_' + id_suffix,
				'class': 'gjson_code language-json'
			}
		);

		div.append($("<br/><br/><br/>"));

		return div;
	}


	function check_missing_value(target, accordion_tab) {
		if (target.val() == "") {
			alert("Field value missing");
			$("#accordion").accordion("option", "active", accordion_tab);
			target.focus();
			return false;
		}
		return true;
	}


	function check_is_numerical(target, accordion_tab) {
		if (!$.isNumeric(target.val())) {
			alert("Field value must be numeric");
			$("#accordion").accordion("option", "active", accordion_tab);
			target.focus();
			return false;
		}
		return true;
	}


	function build_crit_dict(fields_dd) {
	
		var crit_dict = {};
		var val = fields_dd.closest("tr")
			.find("input[type=text]")
			.val();

		crit_dict["attribute"] = fields_dd.val();
		crit_dict["value"] = $.isNumeric(val) ? Number(val) : val;
		crit_dict["operator"] =
			fields_dd
				.closest("tr")
				.find(".s_pps_operators")
				.val();

		return crit_dict;
	}

	function init_tooltipster() {
	
		// Init tooltips
		$('.tooltip').tooltipster(
			{
				plugins: ['follower'],
				theme: [
					'tooltipster-shadow', 
					'tooltipster-shadow-customized'
				]
			}
		);
	}


	function del_chain_rule(event) {
		$(event).closest(".t0outerdiv").fadeOut(
			function() {
				$(this).closest(".t0outerdiv").remove();
			}
		);
	}


	function del_alert_crit(event) {

		closest_table = $(event).closest("table");

		if (closest_table.find('tr').length == 2) {
			alert("First criterium cannot be deleted");
			return;
		}

		$(event).closest("tr").fadeOut(
			function() {
				// delete first '&' 
				closest_table.find('tr').eq(1).find('td').eq(0).html("");
				// delete row 
				$(this).remove();
			}
		);

	}

	function add_or_rule(operator) {
		new_tlb = tbl_model.clone();
		var ilc = new_tlb.find('.inner_logical_connector').eq(0);
		ilc.html("<b>"+operator+"</b>");
		ilc.attr({"data-logical-connection": operator});
		new_tlb.find('.outer_logical_connector').show();
		new_tlb.find('.delete_chain_rule').show();
		new_tlb.hide().appendTo("#t0outerdivs").fadeIn("slow");
	}

	function add_alert_crit(event) {

		closest_tr = $(event).closest("tr");

		if (closest_tr.find(".filter_crit_val").eq(0).val() == "") {
			alert("Please fill text field first");
			closest_tr.find(".filter_crit_val").eq(0).focus();
			return;
		}

		if (
			closest_tr.next() !== undefined && 
			closest_tr.next().find(".filter_crit_val").eq(0).val() == ""
		) {
			alert("Please fill existing text field first");
			closest_tr.next().find(".filter_crit_val").eq(0).focus();
			return;
		}

		dd_fields = $("<select id='aa' class='s_fields'></select>");
		populate_dd(dd_fields, ztf_alert_fields);

		dd_ops = $("<select class='s_pps_operators'></select>");
		populate_dd(dd_ops, pps_operators);

		row = $('<tr></tr>');
		row.append($('<td><div style="position:relative;top:-20px"><b>&</b></div></td>'));
		row.append($('<td></td>').append(dd_fields));
		row.append($('<td></td>').append(dd_ops));

		text_input = $('<input type="text" class="filter_crit_val"></input>');
		text_input.on(
			"keydown", 
			function (e) {
    			if (e.keyCode === 13) { // pressed key is "Enter"
        			add_alert_crit(text_input);
    			}
			}
		);
		row.append(text_input);

		// Plus button
		td = $('<td></td>');
		plus_button = $('<img></img>');
		plus_button.attr(
			{
				'src': 'plus.svg',
				'class': 'new-alert-crit', 
				'height': 24,
				'width': 24
			}
		);

		plus_button.bind(
			'click', 
			function() {
				add_alert_crit(this);
			}
		);
		td.append(plus_button);

		
		row.append(td);
		
		// Trash button
		td = $('<td></td>');
		del_button = $('<img></img>')
		del_button.attr(
			{
				'src': 'trash.svg',
				'class': 'del-alert-crit',
				'height': 24,
				'width': 24
			}
		);

		del_button.bind(
			'click', 
			function() {
				del_alert_crit(this);
			}
		);

		td.append(del_button);
		row.append(td);

		row.hide().insertAfter(closest_tr).fadeIn("slow");
		dd_fields.focus();
  }

  function populate_dd(obj, arr) {

	for (var i=0; i < arr.length; i++) {
		option = $('<option/>');
		option.attr({'value': arr[i]}).text(arr[i]);
    	obj.append(option);
	}
  }

	function create_t2(unit_dict, run_config_dict) {

		var t2_unit_name = unit_dict['_id'];
	
		var outerdiv = $('<div/>');
		outerdiv.attr(
			{
				'id': 'div_' + t2_unit_name,
				'style': 'padding-top:14px',
				'class': 't2div',
				'data-t2-unit-name': t2_unit_name
			}
		);
	
	
		var ttunitdiv = $('<div/>');
		outerdiv.append(ttunitdiv)
		ttunitdiv.attr(
			{
				'class': 'tooltip_templates',
				'style': 'display:none'
			}
		);
	
		var ttunitspan = $('<span/>');
		ttunitdiv.append(ttunitspan);
		ttunitspan.attr({'id': 'tt_content_' + t2_unit_name});
	
		var ttunititlespan = $('<span/>');
		ttunitspan.append(ttunititlespan);
		ttunititlespan.attr({'style': 'color:darkblue; font-weight: bold'});
		ttunititlespan.text(unit_dict.description.title);
		
		ttunitspan.append($('<br/><br/>'));
	
		for (var i = 0; i < unit_dict.description.details.length; i++) {
			ttunitspan.append(
				document.createTextNode(
					unit_dict.description.details[i]
				)
			);
			ttunitspan.append($("<br/>"));
		}
	
		var span = $('<span/>');
		outerdiv.append(span);
		span.attr(
			{
				'class': 'tooltip', 
				'data-tooltip-content': '#tt_content_' + t2_unit_name 
			}
		);
	
		var chkbx = $('<input/>');
		span.append(chkbx);
		chkbx.attr(
			{
				'type': 'checkbox',
				'class': 't2_checkbox',
				'id': t2_unit_name
			}
		);

		chkbx.bind(
			'click', 
			function() {
				$('#table_runconfig_' + t2_unit_name).fadeToggle("slow");
			}
		);
	
		var lbl = $('<label/>');
		span.append(lbl);
		lbl.attr(
			{
				'for': t2_unit_name,
				'style': 'cursor: pointer'
			}
		);
		lbl.text(t2_unit_name);

	
		var table = $('<table/>');
		outerdiv.append(table);
	
		table.attr(
			{
				'id': 'table_runconfig_' + t2_unit_name,
				'cellpadding': 5,
				'cellspacing': 5, 
				'style': 'display:none;padding-left:22px;padding-top:5px'
			}
		);
	
		table.append($('<tr><td><b>Run config:</b></td></tr>'));
	
		for (i=0; i < run_config_dict.length; i++) {
	
			if (run_config_dict[i]["t2Unit"] != t2_unit_name)
				continue;

			var d = $.extend({}, run_config_dict[i]);
			delete d['_id'];
			var rcid = t2_unit_name + '_' + d['runConfig'];
	
			var tr = $('<tr/>');
			table.append(tr);
			var td = $('<td/>');
			tr.append(td);
	
			var ttrunconfigdiv = $('<div/>');
			td.append(ttrunconfigdiv);
			ttrunconfigdiv.attr(
				{
					'class': 'tooltip_templates',
					'style': 'display:none'
				}
			);
	
			var ttrunconfigspan = $('<span/>');
			ttrunconfigdiv.append(ttrunconfigspan);
			ttrunconfigspan.attr({'id': 'tt_' + rcid});
			var pre = $('<pre/>');
			ttrunconfigspan.append(pre);

			pre.text(JSON.stringify(d, undefined, '\t'));
			pre.attr({'style': 'line-height:25px'});

			var input = $('<input/>');
			input.attr(
				{
					'type': 'radio',
					'name': 'radio_' + t2_unit_name,
					'id': 'radio_' + rcid,
					'data-runconf-label': d['runConfig']
				}
			);
		
			input.bind(
				'click', 
				function() {
					$("#runconfig_div_" + t2_unit_name).fadeOut("slow");
				}
			);
		
			td.append(input);
	
			span = $('<span/>');
			td.append(span);
			span.attr(
				{
					'class': 'tooltip', 
					'data-tooltip-content': '#tt_' + rcid 
				}
			);
		
			var lbl = $('<label/>');
			lbl.attr(
				{
					'for': 'radio_' + rcid,
					'style': 'cursor: pointer;padding-left: 5px'
				}
			);
			lbl.text(d['runConfig']);
		
			span.append(lbl);
		}
	
	
		var tr = $('<tr/>');
		table.append(tr);
		var td = $('<td/>');
		tr.append(td);
	
		var input = $('<input/>');
		input.attr(
			{
				'type': 'radio',
				'name': 'radio_' + t2_unit_name,
				'class': "t2_custom",
				'id': t2_unit_name + '_custom',
				'data-runconf-label': 'custom'
			}
		);
	
		input.bind(
			'click', 
			function() {
				$("#runconfig_div_" + t2_unit_name).fadeIn("slow");
			}
		);
	
		td.append(input);
	
		lbl = $('<label/>');
		lbl.attr(
			{
				'for': t2_unit_name + '_custom',
				'style': 'cursor: pointer;padding-left: 5px'
			}
		);
		lbl.text('custom');
	
		td.append(lbl);

		var runconfigdiv = $('<div/>');
		td.append(runconfigdiv);
		runconfigdiv.attr(
			{
				'id': 'runconfig_div_' + t2_unit_name,
				'style': 'display:none;'
			}
		);

		var crc_table = $('<table/>');
		runconfigdiv.append(crc_table);
		crc_table.attr(
			{
				'style': 'margin-left:24px; padding:5px',
				'cellpadding': 5
			}
		);

		for (var z=0; z<t2_run_config_fields.length; z++) {

			crc_table.append($('<tr/>'));
			td = $('<td/>');
			crc_table.append(td);
			td.attr({'style': 'vertical-align: middle; padding-right:10px'});

			span = $('<span/>');
			td.append(span);
			span.attr(
				{
					'class': 'tooltip', 
					'data-tooltip-content': '#tt_' + t2_run_config_fields[z],
					'style': 'cursor: pointer'
				}
			);
			span.append(
				document.createTextNode(t2_run_config_fields[z]+": ")
			);

			td = $('<td/>');
			crc_table.append(td);


			// parameters 'private' and 'parameters' get special treatment
			if (t2_run_config_fields[z][0] != "p") {

				input = $('<input/>');
				td.append(input);

				input.attr(
					{
						'type': 'text',
						'id': 'customrc_' + t2_unit_name + "_" + t2_run_config_fields[z],
						'data-runconf-custom-el': t2_run_config_fields[z]
					}
				);

				if (t2_run_config_fields[z] == "t2Unit") {
					input.attr({'value': t2_unit_name});
					input.prop("disabled", true);
				}

				if (t2_run_config_fields[z] == "version") {
					input.attr({'value': "1.0"});
				}

				if (t2_run_config_fields[z] == "lastChange") {
					var date = new Date();
					input.attr(
						{
							'value': 
								pad_zero(date.getMonth()+1) + "." + 
								pad_zero(date.getDate()) + "." + 
								pad_zero(date.getFullYear()) + "  " +
								pad_zero(date.getHours())  + ":" +
								pad_zero(date.getMinutes())
						}
					);
				}
			}
			else {

				if (t2_run_config_fields[z] == "parameters") {
	
					var textarea = $("<textarea/>")
					td.append(textarea);
					textarea.attr(
						{
							'id': 'customrc_' + t2_unit_name + "_textarea",
							'style': "width: 300px; height: 100px;",
							'data-runconf-custom-el': t2_run_config_fields[z]
						}
					);
					textarea.append(
						document.createTextNode("{\n    \n    \n    \n}")
					);
				}
				else if (t2_run_config_fields[z] == "private") {

					var sel = $("<select/>");
					td.append(sel);
					sel.attr(
						{
							'class': 'select_indent',
							'data-runconf-custom-el': 'private', 
							'style': 'width:80px;'
						}
					);
					sel.append(
						$("<option value='false'>false</option><option value='true'>true</option>")
					);
				}
			}
		}

		$("#T2").append(outerdiv);

	}

	function toggle_table(name) {
		$("#table_runconfig_" + name).fadeToggle("slow");
	}

	function pad_zero(num) {
	    return (num >= 0 && num < 10) ? "0" + num : num + "";
	}

</script>

<style>

	body {
		font-family: Arial, Helvetica, sans-serif;
	}

	table {
		font-size: 1em;
	}

	.ui-draggable, .ui-droppable {
		background-position: top;
	}

	input {
		padding: 3px
	}

	.button {
		background-color: #008CBA;
	    border: none;
	    color: white;
	    padding: 12px 20px;
	    text-align: center;
	    text-decoration: none;
	    display: inline-block;
	    font-size: 16px;
		border-radius: 5px;
		cursor: pointer;
		box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 2px 10px 0 rgba(0,0,0,0.1);
	}

	.button:hover {
		box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
 		text-shadow: 0 0 1px #333;
    	-webkit-transition-duration: 0.2s; /* Safari */
    	transition-duration: 0.2s;
	}

	.button:active {
		transform: perspective(1px) scale(1.05)
	}

	img {
		cursor: pointer;
	}

	input[type=checkbox] {
  		/* Bigger checkboxes */
		-ms-transform: scale(1.5); /* IE */
		-moz-transform: scale(1.5); /* FF */
		-webkit-transform: scale(1.5); /* Safari and Chrome */
		-o-transform: scale(1.5); /* Opera */
		padding: 10px;
		margin-right: 10px
	}

	select {
		height: 30px;
		border: 1px solid #636363;
		cursor: pointer;
		margin-left: 0px;
		text-align: center;
		font-size: 105%;
		vertical-align:middle;  
	}

	.tooltipster-follower.tooltipster-shadow.tooltipster-shadow-customized .tooltipster-content {
		padding: 18px;
		/*border: 2px solid #483C32;*/
		border-radius: 5px;
		background-color: #FCFCFC;
		color: #008CBA;
		box-shadow:0 0 10px 10px rgba(0,0,0,.1);
		font-size: 12pt;
	}

	.ui-state-active, 
	.ui-widget-content .ui-state-active, 
	.ui-widget-header .ui-state-active, 
	a.ui-button:active, 
	.ui-button:active, 
	.ui-button.ui-state-active:hover {
		border: 1px solid #623b00;
    	/* background: #e67a3f; */
    	background: #008CBA;
    	font-weight: normal;
    	color: #fff;
	}

	.tblfixedheight {
    	table-layout: fixed;
	}

	.tblfixedheight td {
    	height: 30px;
    	overflow: hidden;
		text-align: left;
	}

	.tooltip {
  		cursor: pointer;
	}

	.s_alert_operators {
		width: 65px
	}

	.s_pps_operators {
		width: 100px
	}

	.select_indent  {
		text-indent: 10px;
	}

	/* */
	.language-json.pre {
		padding: 20px 80px 20px 40px;
	}
	pre[class*="language-"] {
		padding: 20px 80px 20px 40px;
	}


	/* firefox specific css hack */
	@-moz-document url-prefix() {
	    .select_indent  {
	       text-indent: 0px;
	    }
	}

	.gjson_pre {
		display: inline-block; 
		background: #f5f5f5; 
		border: 1px #008CBA solid; 
		padding: 20px 80px 20px 40px;
	}

	.gjson_code {
		/*padding: 20px 80px 20px 40px;*/
	}

	.token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string {
    	background: transparent;
	}

	.token.number {
		/*font-weight: bold;*/
		color: #db6c00;
	}

	.token.boolean {
		/*font-weight: bold;*/
		color: #0202b9;
	}

	.slackpublisher {
		border: 1px #aaa solid;
		display: none;
		padding: 10px;
		border-radius: 5px;
		margin: 15px;
		border-spacing: 5px;
		line-height: 40px;
	}

  </style>

  <title>AMPEL channel configurator</title>

</head>

<body>

<center>
	<h1>AMPEL channel configurator</h1>
</center>

<div id="accordion">

  <h3>Channel details</h3>

  <div>

  		<table class="tblfixedheight" cellspacing=5 cellpadding=5>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_instrument"> 
        		Instrument:
			</span>
		</td>
		<td>
        	<span style="color:grey">ZTF</span>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_alert_source"> 
				Alert source: 
			</span>
		</td>
		<td>
        	<span style="color:grey">IPAC</span>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_channel_name"> 
				Channel name:
			</span>
		</td>
		<td>
			<input type="text" id="channel_name" class="channel_details_input" style="width:200px"/>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_channel_author"> 
				Author:
			</span>
		</td>
		<td>
			<input type="text" id="channel_author" class="channel_details_input" style="width:200px"/>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_channel_contact"> 
				Contact:
			</span>
		</td>
		<td>
			<input type="text" id="channel_contact" class="channel_details_input" style="width:200px"/>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_channel_github"> 
				Github:
			</span>
		</td>
		<td>
			<input type="text" id="channel_github" class="channel_details_input" style="width:200px"/>
		</td>
		</tr>

		<tr>
		<td>
			<span class="tooltip" data-tooltip-content="#tt_partnership"> 
				Partner:
			</span>
		</td>
		<td>
			<select id="partner" class="select_indent" style="width:80px;">
				<option value="false">false</option>
				<option value="true">true</option>
			</select>
		</td>
		</tr>

		</table>	
		
		<div class="tooltip_templates" style="display:none">

	    	<span id="tt_instrument">
	    	    <span style="color:darkblue"><b>Instrument</b></span>
				<br> <br>
				Documentation will follow...<br>
	    	</span>

	    	<span id="tt_alert_source">
	    	    <span style="color:darkblue"><b>Alert source</b></span>
				<br> <br>
				Documentation will follow...<br>
	    	</span>

	    	<span id="tt_channel_name">
	    	    <span style="color:darkblue"><b>Channel name</b></span>
				<br> <br>
				Documentation will follow...<br>
	    	</span>

	    	<span id="tt_channel_author">
	    	    <span style="color:darkblue"><b>Channel author</b></span>
				<br> <br>
				Name of a person or an organization<br>
	    	</span>

	    	<span id="tt_channel_contact">
	    	    <span style="color:darkblue"><b>Channel contact</b></span>
				<br> <br>
				Preferably an email address<br>
	    	</span>

	    	<span id="tt_channel_github">
	    	    <span style="color:darkblue"><b>Channel github</b></span>
				<br> <br>
				URL of repository storing this channel information<br>
	    	</span>

	    	<span id="tt_partnership">
	    	    <span style="color:darkblue"><b>Partner</b></span>
				<br> <br>
				Preferably an email address<br>
	    	</span>

		</div>

  </div>


  <h3>Tier 0: Filtering</h3>
  <div id="acc-t0">

	<div id="t0outerdivs">

	<br>
	<div class="t0outerdiv">

	<div class="outer_logical_connector" style="display:none">	
	<br>
	<!-- div inner_logical_connector is used in js function add_or_rule() -->
	<div class="inner_logical_connector" style="text-align:center"></div>
	<br>
	</div>

	<table id="t0outer" cellspacing="10" 
		style="border: 1px #aaa solid;border-radius:5px;background-color:#f2f2f2">

	<tr>
	<td>

		<table cellspacing="10" style="width:100%">
		<tr>
		<th></th>
		<th>Operator</th>
		<th>Value</th>
		<th width="100%" align="right">
			<img src="close.svg" class="delete_chain_rule" alt="image"
				height=20 width=20
				style="display:none; top: -10px; position: relative; right: -10px;"
				onclick="javascript:del_chain_rule(this)"
			/>
		</th>
		</tr>

		<tr align="center">
		<td nowrap>Matching PPS #</td>
		<td><select class="s_alert_operators select_indent"></select></td>
		<td>
			<input type="text" style="width:50px" class="rule_pps_len">
		</td>
		<td>
		</td>
		</tr>
		</table>

	</td>
	</tr>
	<tr>
	<td>

		<table 
			id="t0" cellspacing="10" 
			style="border: 1px #aaa solid;border-radius:5px;background-color:#e6e6ff"
		>

			<tr>
			<th></th>
			<th>
				<a 
					href="https://zwickytransientfacility.github.io/ztf-avro-alert/schema.html#ztfalertcandidate" 
					target="_blank"
					style="color:blue"
				>
					Property
				</a>
			</th>
			<th>Operator</th>
			<th>Value</th>
			<th></th>
			<th></th>
			</tr>

			<tr align="center">
			<td></td>
			<td><select class="s_fields" style="text-align:middle"></select></td>
			<td><select class="s_pps_operators select_indent"></select></td>
			<td>
				<input type="text" class="filter_crit_val keypress_new_alert_crit">
			</td>
			<td>
				<img src="plus.svg" alt="image"
					class="new-alert-crit" 
					height=24 width=24 
					style="color:green"
					onclick="javascript:add_alert_crit(this)"
				/>
			</td>
			<td>
				<img src="trash.svg" alt="image"
					class="del-alert-crit" 
					height=24 width=24
					onclick="javascript:del_alert_crit(this)"
				/>
			</td>
			</tr>

		</table>

		</td>
		</tr>
	</table>

	</div>
	</div>

	<br>
	<br>

	<button class="button" onclick="javascript:add_or_rule('OR')">Add <b>OR</b> criteria</button>
	&nbsp; &nbsp;
	<button class="button" onclick="javascript:add_or_rule('AND')">Add <b>AND</b> criteria</button>

	<br>
	<br>
	<br>

	<hr>
	<br>
	<span class="tooltip" data-tooltip-content="#tt_autocomplete"> 
		<input type="checkbox" id="autocomplete"/>
		<label for="autocomplete" style="cursor: pointer">Auto complete</label>
	</span>
	<br>
	<br>
	<hr>

	<br>

	<div class="tooltip_templates" style="display:none">
	    <span id="tt_autocomplete">
	        <span style="color:darkblue"><b>Auto-complete</b></span>
			<br> <br>
			Documentation will follow...<br>
	    </span>
  	</div>

  </div>

  <h3>Tier 2: Computation</h3>
  <div id="T2">

		<div class="tooltip_templates" style="display:none">

		    <span id="tt_t2Unit">
		        <span style="color:darkblue"><b>t2Unit</b></span>
				<br> <br>
				AMPEL computation unit name.<br>
				Not editable, displayed here for the sake of completeness.<br>
		    </span>
		
		    <span id="tt_runConfig">
		        <span style="color:darkblue"><b>runConfig</b></span>
				<br> <br>
				Run configuration string id.<br>
				Uniquely identifies the present set of parameters with the given id.<br>
		    </span>
		
		    <span id="tt_author">
		        <span style="color:darkblue"><b>author</b></span>
				<br> <br>
				Author of this run configuration.<br>
				Preferably an email address, otherwise a name.<br>
		    </span>
		
		    <span id="tt_version">
		        <span style="color:darkblue"><b>version</b></span>
				<br> <br>
				Version of this run configuration.<br>
				Float number starting with 1.0<br>
		    </span>
		
		    <span id="tt_private">
		        <span style="color:darkblue"><b>private</b></span>
				<br> <br>
				Determines wether or not your implemented run configuration<br>
				should be visible (and thus usable) to others.<br>
		    </span>
		
		    <span id="tt_lastChange">
		        <span style="color:darkblue"><b>lastChange</b></span>
				<br> <br>
				Date and time of last edit
		    </span>
		
		    <span id="tt_parameters">
		        <span style="color:darkblue"><b>parameters</b></span>
				<br> <br>
				JSON structure holding a set of parameters <br>
				that will be provided to the T2 computation unit during run time.
		    </span>

		</div>
  </div>

  <h3>Tier 3: Interface</h3>
  <div>
	<div>
		<input type="checkbox" id="slackpublisher"/>
		<label for="slackpublisher" style="cursor: pointer">Slack Publisher</label>

		<table id="tableslackpublisher" class="slackpublisher">
			<tr><td> Channel: <input type="text" id="spchannel"/> </td></tr>
			<tr><td> Authorization token: <input type="text" id="spauthtoken"/> </td></tr>
		</table>
	</div>
	<br> 
	<div>
		<input type="checkbox" id="bla"/>
		<label for="bla" style="cursor: pointer">Bla Publisher</label>

		<table id="tablebla" style="border: 1px #aaa solid; display:none; padding:10px; border-radius:5px;margin:15px">
			<tr><td> Channel: <input type="text" id="aaa"/> </td></tr>
			<tr><td> Authorization token: <input type="text" id="bbb"/> </td></tr>
		</table>
	</div>
  </div>

  </div>

<br><br>
<button id="doit" class="button">Generate</button>


</body>
</html>
